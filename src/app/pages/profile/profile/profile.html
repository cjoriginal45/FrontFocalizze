<app-header></app-header>

<div class="profile-page">
  @if (isLoading && !profile) {
    <p class="profile-page__loading">{{ 'CATEGORY.LOADING' | translate }}</p>
  <!-- O un spinner de Material -->
  } @if (profile) {
  <!-- Contenedor superior con la información del usuario -->
  <header class="profile-header">
    <!-- Sección Izquierda: Avatar e Info Básica -->
    <div class="profile-header__left">
      <img
        [src]="profile.avatarUrl"
        [alt]="'PROFILE.AVATAR_ALT' | translate:{name: profile.displayName}"
        class="profile-header__avatar"
      />
      <div class="profile-header__user-identity">
        <h1 class="profile-header__display-name">{{ profile.displayName }}</h1>
        <p class="profile-header__username">@{{ profile.username }}</p>
      </div>
    </div>

    <!-- Sección Derecha: Bio, Estadísticas y Acciones -->
    <div class="profile-header__right">
      <h2 class="biography-title">{{ 'EDIT_PROFILE.BIO_LABEL' | translate }}</h2>
      <p class="profile-header__biography">
        {{ profile.biography || ('PROFILE.NO_BIO' | translate) }} <!-- Necesitas añadir NO_BIO al JSON -->
      </p>

      <div class="profile-header__stats">
        <!-- SIGUIENDO (Clickable) -->
        <div class="stat clickable" (click)="openFollowModal('following')" matRipple>
          <span class="stat__value">{{ profile.follow }}</span>
          <span class="stat__label">{{ 'PROFILE.FOLLOWING' | translate }}</span>
        </div>

        <!-- SEGUIDORES (Clickable) -->
        <div class="stat clickable" (click)="openFollowModal('followers')" matRipple>
          <span class="stat__value">{{ profile.followers }}</span>
          <span class="stat__label">{{ 'PROFILE.FOLLOWERS' | translate }}</span>
        </div>

        <div class="stat">
          <span class="stat__value">{{ profile.threadCount }}</span>
          <span class="stat__label">{{ 'PROFILE.THREADS_PUBLISHED' | translate }}</span>
        </div>
        <!-- Solo muestra los hilos disponibles si es nuestro propio perfil -->
        @if (isOwnProfile && profile.threadsAvailableToday !== null) {
        <div class="stat">
          <span class="stat__value">{{ profile.threadsAvailableToday }}</span>
          <span class="stat__label">{{ 'PROFILE.THREADS_AVAILABLE' | translate }}</span> 
        </div>
        }
      </div>

      <div class="profile-header__meta">
        <mat-icon class="meta__icon">calendar_today</mat-icon>
        <span class="meta__text">{{ 'PROFILE.JOINED' | translate }} {{ profile.registerDate | date : 'MMMM yyyy' }}</span>
      </div>
    </div>

    @if (isOwnProfile) {
    <button mat-stroked-button class="profile-header__edit-btn" (click)="editProfile()">
      {{ 'EDIT_PROFILE.TITLE' | translate }}
    </button>
    } @else {
      <div class="profile-header__action-btn">
        <app-follow-button
          type="user"
          [identifier]="profile.username"
          (followStateChanged)="onFollowChange($event)"
        >
        </app-follow-button>
        <button mat-icon-button [matMenuTriggerFor]="profileMenu" [attr.aria-label]="'THREAD.MORE_OPTIONS' | translate">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #profileMenu="matMenu">
          <button mat-menu-item (click)="blockUser()" [class.text-warn]="profile.isBlocked">
            <mat-icon>{{ profile.isBlocked ? 'lock_open' : 'block' }}</mat-icon>
            <span>{{ (profile.isBlocked ? 'THREAD.UNBLOCK_USER' : 'THREAD.BLOCK_USER') | translate:{username: profile.username} }}</span>
          </button>
        </mat-menu>
      </div>
    }
  </header>

  <!-- Contenedor de Hilos Publicados -->
  <div class="profile-threads">
    <h2 class="profile-threads__title">{{ 'PROFILE.THREADS_PUBLISHED' | translate }}</h2>

    @if (threadIds.length > 0) {
    <div class="profile-threads__list">
      @for (threadId of threadIds; track threadId) {
      <app-thread [threadId]="threadId" (openComments)="openCommentsModal($event)"></app-thread>
      }
    </div>
    } @else if (!isLoading) {
      <p class="profile-threads__no-results">{{ 'PROFILE.NO_THREADS' | translate }}</p> 
    } @if (isLoading && profile) {
      <p>{{ 'CATEGORY.LOADING_MORE' | translate }}</p>
    }
  </div>
  }
</div>
<app-botton-nav></app-botton-nav>
<app-create-thread-button></app-create-thread-button>
