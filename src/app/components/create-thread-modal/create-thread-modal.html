<!-- Mini Header -->
<header class="modal-header">
  <div class="modal-header__left">
    @if (currentStep > 1 && isMobileView) {
    <button
      mat-icon-button
      class="modal-header__button modal-header__back-btn"
      (click)="previousStep()"
    >
      <mat-icon>arrow_back</mat-icon>
    </button>
    }
  </div>
  <h2 class="modal-header__title">{{ 'CREATE_THREAD.TITLE' | translate }}</h2>
  <div class="modal-header__right">
    <button mat-icon-button class="modal-header__button" (click)="showScheduler = !showScheduler">
      <mat-icon [class.active]="showScheduler">schedule</mat-icon>
    </button>
    <button mat-icon-button class="modal-header__button" (click)="closeModal()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</header>

<div class="modal-content" mat-dialog-content>
  <!-- Scheduler Panel (Sin cambios) -->
  @if (showScheduler) {
  <div class="scheduler-panel">
    <h4>{{ 'CREATE_THREAD.SCHEDULE.TITLE' | translate }}</h4>
    <div class="scheduler-inputs">
      <mat-form-field appearance="outline" class="scheduler-inputs__datepicker">
        <mat-label>{{ 'CREATE_THREAD.SCHEDULE.DATE' | translate }}</mat-label>
        <input matInput [matDatepicker]="picker" [(ngModel)]="scheduledDate" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="scheduler-inputs__timepicker">
        <mat-label>{{ 'CREATE_THREAD.SCHEDULE.HOUR' | translate }}</mat-label>
        <mat-select [(ngModel)]="scheduledHour">
          @for (hour of hours; track hour) {
          <mat-option [value]="hour">{{ hour < 10 ? '0' + hour : hour }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="scheduler-inputs__timepicker">
        <mat-label>{{ 'CREATE_THREAD.SCHEDULE.MINUTE' | translate }}</mat-label>
        <mat-select [(ngModel)]="scheduledMinute">
          @for (minute of minutes; track minute) {
          <mat-option [value]="minute">{{ minute < 10 ? '0' + minute : minute }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  }

  <div
    class="unified-threads-container"
    [class.desktop-view]="!isMobileView"
    [class.mobile-view]="isMobileView"
    [class.step-1]="isMobileView && currentStep === 1"
    [class.step-2]="isMobileView && currentStep === 2"
    [class.step-3]="isMobileView && currentStep === 3"
  >
    @for (thread of threads; track $index) {
    <mat-form-field appearance="fill" class="thread-input thread-input-{{ $index }}">
      <mat-label>{{ 'CREATE_THREAD.POST_LABEL' | translate : { number: $index + 1 } }}</mat-label>

      <textarea
        matInput
        #threadInput
        [(ngModel)]="threads[$index]"
        (input)="onTextareaEvent($event, $index)"
        (click)="onTextareaEvent($event, $index)"
        (keyup)="onTextareaEvent($event, $index)"
        (focus)="onTextareaEvent($event, $index)"
        [attr.data-index]="$index"
        [matAutocomplete]="mentionAutocomplete"
        [maxlength]="
          $index === 0 ? charLimits.step1 : $index === 1 ? charLimits.step2 : charLimits.step3
        "
        cdkTextareaAutosize
        [cdkAutosizeMinRows]="$index === 0 ? 3 : 3"
      ></textarea>

      <mat-hint align="end">
        {{ threads[$index].length }} /
        {{ $index === 0 ? charLimits.step1 : $index === 1 ? charLimits.step2 : charLimits.step3 }}
      </mat-hint>

      <!-- BOTÓN EMOJI -->
      <button
        mat-icon-button
        matSuffix
        class="emoji-btn"
        [matMenuTriggerFor]="emojiMenu"
        (click)="$event.stopPropagation()"
        type="button"
      >
        <mat-icon>sentiment_satisfied_alt</mat-icon>
      </button>

      <!-- MENÚ DE EMOJIS -->
      <mat-menu #emojiMenu="matMenu" class="emoji-menu-panel">
        <div (click)="$event.stopPropagation()">
          <emoji-mart
            [showPreview]="false"
            [darkMode]="false"
            [set]="'google'"
            (emojiClick)="addEmoji($event, $index, threadInput)"
          >
          </emoji-mart>
        </div>
      </mat-menu>
    </mat-form-field>
    }
  </div>

  <!-- AUTOCOMPLETE COMPONENT (Compartido para todos los textareas) -->
  <mat-autocomplete
    #mentionAutocomplete="matAutocomplete"
    (optionSelected)="onUserMentionSelected($event)"
    [displayWith]="displayWithFn"
    class="custom-autocomplete"
  >
    @for (user of mentionResults$ | async; track user.username) {
    <!-- El valor es el objeto completo UserSearch -->
    <mat-option [value]="user">
      <div class="user-option">
        <img
          [src]="user.avatarUrl || 'assets/images/default-avatar.webp'"
          class="user-option__avatar"
          alt="Avatar"
        />
        <div class="user-option__info">
          <span class="user-option__display-name">{{ user.displayName }}</span>
          <span class="user-option__username">@{{ user.username }}</span>
        </div>
      </div>
    </mat-option>
    }
  </mat-autocomplete>
</div>

<footer class="modal-footer" mat-dialog-actions>
  <mat-form-field appearance="outline" class="category-selector">
    <mat-label>{{ 'CREATE_THREAD.CATEGORY_LABEL' | translate }}</mat-label>
    <mat-select [(ngModel)]="selectedCategory" name="category">
      <mat-option [value]="null">{{ 'CREATE_THREAD.CATEGORY_NONE' | translate }}</mat-option>
      @for (category of categories; track category.value) {
      <mat-option [value]="category.value">{{ category.viewValue }}</mat-option> }
    </mat-select>
  </mat-form-field>
  <div class="modal-footer__actions">
    @if(isMobileView && currentStep < 3){
    <button mat-flat-button color="primary" class="modal-footer__next-btn" (click)="nextStep()">
      {{ 'CREATE_THREAD.NEXT' | translate }}
    </button>
    } @if(!isMobileView || currentStep === 3){
    <button mat-flat-button color="primary" class="modal-footer__publish-btn" (click)="publish()">
      {{ 'CREATE_THREAD.PUBLISH' | translate }}
    </button>
    }
  </div>
</footer>

@if (errorMessage) {
<div class="modal-error-message">{{ errorMessage }}</div>
}
