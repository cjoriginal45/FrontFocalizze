<!-- HEADER: Sticky en la parte superior -->
<header class="comments-header">
  <h2>{{ 'COMMENTS.TITLE' | translate }}</h2>
  <button mat-icon-button (click)="onClose()" aria-label="Cerrar">
    <mat-icon>close</mat-icon>
  </button>
</header>

<!-- CONTENIDO SCROLEABLE -->
<div class="comments-scroll-area">
  <!-- SECCIÓN INPUT (Añadir comentario) -->
  <section class="add-comment-section">
    <div class="user-avatar-wrapper">
      @if (authService.currentUser(); as user) {
      <img [src]="user.avatarUrl || defaultAvatar" class="avatar" alt="Avatar" />
      } @else {
      <img [src]="defaultAvatar" class="avatar" alt="Default Avatar" />
      }
    </div>

    <div class="input-wrapper">
      <mat-form-field appearance="outline" class="comment-field">
        <textarea
          matInput
          [placeholder]="'COMMENTS.PLACEHOLDER' | translate"
          cdkTextareaAutosize
          [cdkAutosizeMinRows]="1"
          [cdkAutosizeMaxRows]="5"
          [formControl]="commentControl"
          maxlength="280"
        ></textarea>
        <!-- Contador de caracteres discreto -->
        <mat-hint align="end">{{ commentControl.value?.length || 0 }}/280</mat-hint>
      </mat-form-field>

      <div class="input-actions">
        <button
          mat-flat-button
          class="btn-post"
          (click)="postComment()"
          [disabled]="commentControl.invalid"
        >
          {{ 'COMMENTS.BUTTON' | translate }}
        </button>
      </div>
    </div>
  </section>

  <!-- LOADING / LISTA -->
  <section class="comments-list-section">
    @if (isLoading) {
    <div class="loading-state">
      <!-- Puedes poner un spinner aquí -->
      <p>{{ 'COMMENTS.LOADING' | translate }}...</p>
    </div>
    }

    <div class="comments-list">
      @for (comment of comments; track comment.id) {
      <article class="comment-item">
        <!-- Avatar Autor Comentario -->
        <img class="avatar comment-avatar" [src]="comment.author.avatarUrl" alt="Avatar" />

        <div class="comment-content">
          <!-- Header del comentario -->
          <div class="comment-meta">
            <div class="meta-info">
              <span class="author-name">{{ comment.author.displayName }}</span>
              <span class="author-handle">@{{ comment.author.username }}</span>
              <span class="dot-separator">·</span>
              <span class="date">{{ comment.createdAt | timeAgo }}</span>
            </div>

            <!-- Menú Opciones -->
            @if (authService.currentUser()?.username === comment.author.username) {
            <button mat-icon-button [matMenuTriggerFor]="commentMenu" class="more-btn">
              <mat-icon>more_horiz</mat-icon>
            </button>
            <mat-menu #commentMenu="matMenu">
              <button mat-menu-item (click)="openEditComment(comment.id, comment.content)">
                <mat-icon color="primary">edit</mat-icon>
                <span>{{ 'COMMENTS.EDIT' | translate }}</span>
              </button>
              <button mat-menu-item (click)="openDeleteConfirm(comment.id)">
                <mat-icon color="warn">delete</mat-icon>
                <span>{{ 'COMMENTS.DELETE' | translate }}</span>
              </button>
            </mat-menu>
            }
          </div>

          <!-- Texto del comentario -->
          <p class="comment-text">{{ comment.content }}</p>

          <!-- Botón Responder -->
          @if (isThreadAuthor && !replyingToCommentId) {
          <button class="action-link" (click)="startReplying(comment.id)">Responder</button>
          }

          <!-- Formulario Respuesta -->
          @if (replyingToCommentId === comment.id) {
          <div class="reply-form" @fadeIn>
            <mat-form-field appearance="outline" class="full-width dense-field">
              <textarea
                matInput
                [formControl]="replyControl"
                placeholder="Tu respuesta..."
                cdkTextareaAutosize
              ></textarea>
            </mat-form-field>
            <div class="reply-actions">
              <button mat-button (click)="cancelReply()">Cancelar</button>
              <button
                mat-flat-button
                color="primary"
                (click)="sendReply(comment.id)"
                [disabled]="replyControl.invalid"
              >
                Enviar
              </button>
            </div>
          </div>
          }

          <!-- Respuestas anidadas -->
          @if (comment.replies && comment.replies.length > 0) {
          <div class="replies-container">
            @for (reply of comment.replies; track reply.id) {
            <div class="comment-item reply-item">
              <img class="avatar small-avatar" [src]="reply.author.avatarUrl" alt="Avatar" />
              <div class="comment-content">
                <div class="comment-meta">
                  <div class="meta-info">
                    <span class="author-name">{{ reply.author.displayName }}</span>

                    <!-- Badge de Autor -->
                    @if (isThreadAuthor) {
                    <span class="badge-author">Autor</span>
                    }

                    <span class="date">· {{ reply.createdAt | timeAgo }}</span>
                  </div>

                  <!-- Menu Respuesta (Opcional) -->
                  @if (authService.currentUser()?.username === reply.author.username) {
                  <!-- ... tu botón de menú ... -->
                  }
                </div>
                <p class="comment-text">{{ reply.content }}</p>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </article>
      }
    </div>
  </section>
</div>
